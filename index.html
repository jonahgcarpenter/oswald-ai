<!-- NOTE:  -->
<!-- I hate frontend, so this is vibe coded for simple display -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Chat Debugger</title>
    <style>
      :root {
        --bg-color: #1e1e2e;
        --chat-bg: #2b2b3b;
        --user-msg-bg: #4a90e2;
        --ai-msg-bg: #3c3c4e;
        --thinking-bg: #252530;
        --thinking-border: #f39c12;
        --text-color: #ecf0f1;
        --accent-color: #f39c12;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* CHAT CONTAINER */
      #chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 40px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
      }

      /* MESSAGE BUBBLES */
      .message {
        padding: 15px 20px;
        border-radius: 12px;
        line-height: 1.6;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-message {
        align-self: flex-end;
        background-color: var(--user-msg-bg);
        border-bottom-right-radius: 2px;
        max-width: 70%;
      }

      .ai-message {
        align-self: flex-start;
        background-color: var(--ai-msg-bg);
        border-bottom-left-radius: 2px;
        max-width: 85%;
        width: 100%; /* Allow AI to take more space for logs */
      }

      /* THINKING / TOOLS SECTION (COLLAPSIBLE) */
      details.thinking-section {
        background-color: var(--thinking-bg);
        border: 1px solid #444;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
      }

      details.thinking-section summary {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: bold;
        color: #bdc3c7;
        background-color: rgba(255, 255, 255, 0.05);
        list-style: none; /* Hide default triangle in some browsers */
        display: flex;
        align-items: center;
        gap: 8px;
      }

      details.thinking-section summary::before {
        content: "üõ†Ô∏è";
      }

      details.thinking-section summary:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      /* The logs container inside the details */
      .logs-container {
        padding: 10px;
        background-color: #181820;
        border-top: 1px solid #444;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.85em;
      }

      .log-entry {
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #333;
        white-space: pre-wrap; /* Wrap long JSON lines */
        word-break: break-all;
      }

      .log-entry.error {
        color: #e74c3c;
      }

      .log-entry .tool-name {
        color: var(--accent-color);
        font-weight: bold;
      }

      /* FINAL TEXT RESPONSE */
      .ai-text-content {
        font-size: 1.05em;
      }

      /* INPUT AREA */
      #input-area {
        background-color: var(--chat-bg);
        padding: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .input-wrapper {
        display: flex;
        gap: 10px;
        max-width: 900px;
        width: 100%;
      }

      textarea {
        flex: 1;
        background: #1e1e2e;
        border: 1px solid #555;
        color: white;
        padding: 15px;
        border-radius: 8px;
        resize: none;
        height: 50px;
        font-family: inherit;
      }

      textarea:focus {
        outline: 2px solid var(--accent-color);
        border-color: transparent;
      }

      button {
        background-color: var(--accent-color);
        border: none;
        color: white;
        padding: 0 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }

      button:hover {
        filter: brightness(1.1);
      }

      button:disabled {
        background-color: #555;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div id="chat-history">
      <div class="message ai-message">
        <div class="ai-text-content">
          Hello! I am your MCP Agent. I can access Discord. How can I help?
        </div>
      </div>
    </div>

    <div id="input-area">
      <div class="input-wrapper">
        <textarea
          id="prompt-input"
          placeholder="Type your instruction here..."
        ></textarea>
        <button id="send-btn" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      const chatHistory = document.getElementById("chat-history");
      const promptInput = document.getElementById("prompt-input");
      const sendBtn = document.getElementById("send-btn");

      async function sendMessage() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        // 1. Add User Message
        appendUserMessage(prompt);
        promptInput.value = "";
        sendBtn.disabled = true;

        // 2. Create the AI Message Structure (Thinking + Content)
        const uiElements = createAiMessageStructure();

        try {
          const response = await fetch(
            "http://localhost:8000/api/v2/chat/send",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ prompt: prompt }),
            },
          );

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop();

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const jsonStr = line.replace("data: ", "").trim();
                if (jsonStr === "[DONE]") break;

                try {
                  const data = JSON.parse(jsonStr);
                  // Pass the specific container elements to the processor
                  processStreamData(data, uiElements);
                } catch (e) {
                  console.error("JSON Parse Error:", e);
                }
              }
            }
          }
        } catch (err) {
          uiElements.textContentDiv.innerHTML += `<br><span style="color:red">Error: ${err.message}</span>`;
        } finally {
          sendBtn.disabled = false;
        }
      }

      function appendUserMessage(text) {
        const div = document.createElement("div");
        div.className = "message user-message";
        div.textContent = text;
        chatHistory.appendChild(div);
        scrollToBottom();
      }

      // Creates the specific DOM structure for an AI response
      function createAiMessageStructure() {
        const msgDiv = document.createElement("div");
        msgDiv.className = "message ai-message";

        // 1. The Collapsible Thinking Section
        const details = document.createElement("details");
        details.className = "thinking-section";
        details.open = true; // Open by default while generating, can close later if desired

        const summary = document.createElement("summary");
        summary.textContent = "Agent Thought Process";

        const logsContainer = document.createElement("div");
        logsContainer.className = "logs-container";

        details.appendChild(summary);
        details.appendChild(logsContainer);

        // 2. The Final Text Content
        const contentDiv = document.createElement("div");
        contentDiv.className = "ai-text-content";

        msgDiv.appendChild(details);
        msgDiv.appendChild(contentDiv);
        chatHistory.appendChild(msgDiv);
        scrollToBottom();

        return {
          logsDiv: logsContainer,
          textContentDiv: contentDiv,
          detailsElement: details,
        };
      }

      function processStreamData(data, uiElements) {
        // If we get a "token", append to the text area
        if (data.type === "token") {
          uiElements.textContentDiv.innerHTML += data.content.replace(
            /\n/g,
            "<br>",
          );

          // Optional: Auto-close the thinking steps once real text starts arriving
          // if (uiElements.detailsElement.open) uiElements.detailsElement.open = false;

          scrollToBottom();
        }

        // If we get "thinking" or "error", append to the logs area
        else if (data.type === "thinking" || data.type === "error") {
          const logEntry = document.createElement("div");
          logEntry.className =
            "log-entry" + (data.type === "error" ? " error" : "");

          // Simple formatting to highlight "Tool Result" vs "Accessing Tool"
          let text = data.content;
          if (text.includes("Accessing Tool:")) {
            text = text.replace(
              "Accessing Tool:",
              "<span class='tool-name'>Accessing Tool:</span>",
            );
          } else if (text.includes("Tool Result:")) {
            text = text.replace(
              "Tool Result:",
              "<span class='tool-name'>Tool Result:</span>",
            );
          }

          logEntry.innerHTML = text;
          uiElements.logsDiv.appendChild(logEntry);

          // Auto-scroll the logs container
          uiElements.logsDiv.scrollTop = uiElements.logsDiv.scrollHeight;
        }
      }

      function scrollToBottom() {
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      promptInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
